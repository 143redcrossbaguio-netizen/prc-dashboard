<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRC Baguio - Donor Database</title>
<style>
body {
    font-family: Arial, sans-serif;
    background: #fff;
    color: #b71c1c; /* red accent */
    margin: 0; padding: 0;
}
header {
    background: #b71c1c;
    color: white;
    padding: 10px 20px;
    display: flex;
    align-items: center;
}
header img {
    height: 50px;
    margin-right: 15px;
}
h1, h2 {
    margin: 5px 0;
}
.container {
    padding: 20px;
}
#entrySection, #donorListSection {
    margin-bottom: 30px;
}
input, select {
    padding: 5px;
    margin: 3px 0;
    font-size: 14px;
}
input[type="text"], input[type="number"], input[type="date"] {
    width: 150px;
}
input[type="submit"], button {
    padding: 10px 20px;
    background: #b71c1c;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 14px;
}
table {
    width: 100%;
    border-collapse: collapse;
}
table, th, td {
    border: 1px solid #b71c1c;
}
th, td {
    padding: 5px;
    text-align: left;
    font-size: 13px;
}
.bloodA {background-color: lightblue;}
.bloodB {background-color: lightyellow;}
.bloodAB {background-color: lightpink;}
.bloodO {background-color: white;}
.month {
    background: #f5f5f5;
    font-weight: bold;
}
.highlight {
    background: #ffff99;
}
</style>
</head>
<body>

<header>
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f5/Philippine_Red_Cross_logo.svg/1200px-Philippine_Red_Cross_logo.svg.png" alt="PRC Logo">
    <div>
        <h1>Philippine Red Cross</h1>
        <h2>Baguio City Chapter</h2>
    </div>
</header>

<div class="container">
    <!-- Donor Entry Section -->
    <div id="entrySection">
        <h2>Donor Entry</h2>
        <form id="donorForm">
            Date: <input type="date" id="date" required><br>
            Donor Type (W/M/P): <input type="text" id="donorType" maxlength="1"> <input type="text" id="extraBox" placeholder="Extra if M/P"><br>
            Surname: <input type="text" id="surname" required> Suffix: <input type="text" id="suffix" maxlength="3"><br>
            First Name: <input type="text" id="fname" required> Middle Name: <input type="text" id="mname"><br>
            Birth: 
            MM <input type="number" id="bMonth" min="1" max="12" style="width:50px;"> 
            DD <input type="number" id="bDay" min="1" max="31" style="width:50px;"> 
            YYYY <input type="number" id="bYear" min="1900" max="2100" style="width:70px;">
            Age: <input type="number" id="age" readonly><br>
            Address: <input type="text" id="address" style="width:200px;"> 
            City/Region: <input type="text" id="city" maxlength="15"><br>
            Contact: <input type="text" id="contact1" maxlength="4" style="width:50px;"> - 
                     <input type="text" id="contact2" maxlength="3" style="width:40px;"> - 
                     <input type="text" id="contact3" maxlength="4" style="width:50px;"><br>
            Serial Number: <input type="text" id="serialNumber" placeholder="PRC2600-"><br>
            Blood Type (AP/AN/BP/BN/ABP/ABN/OP/ON): <input type="text" id="bloodType"><br>
            # Donations: <input type="number" id="numDonations" min="1" value="1"><br>
            Bag Used (K/T): <input type="text" id="bagUsed" maxlength="1">
            Bag Type (S/D/T/Q): <input type="text" id="bagType" maxlength="1"><br>
            Amount (4/Q/U): <input type="text" id="amount" maxlength="1"><br>
            Time Started HH <input type="number" id="startHH" min="1" max="12" style="width:50px;">
            MM <input type="number" id="startMM" min="0" max="60" style="width:50px;"><br>
            Time Ended HH <input type="number" id="endHH" min="1" max="12" style="width:50px;">
            MM <input type="number" id="endMM" min="0" max="60" style="width:50px;"><br><br>
            <input type="submit" value="Submit">
        </form>
    </div>

    <!-- Donor List Section -->
    <div id="donorListSection">
        <h2>Donor List</h2>
        <input type="text" id="searchDonor" placeholder="Search donor list..." style="width:100%; padding:5px; margin-bottom:10px; font-size:14px;">
        <button id="exportBtn">Export as Excel</button>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Donor Type</th>
                    <th>Name</th>
                    <th>Suffix</th>
                    <th>Age</th>
                    <th>Address</th>
                    <th>City</th>
                    <th>Contact</th>
                    <th>Serial</th>
                    <th>Blood Type</th>
                    <th># Donations</th>
                    <th>Bag Used</th>
                    <th>Bag Type</th>
                    <th>Amount</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                </tr>
            </thead>
            <tbody id="donorTable"></tbody>
        </table>
    </div>
</div>

<script>
let donors = JSON.parse(localStorage.getItem("donors") || "[]");

// Auto-fill age
document.getElementById("bYear").addEventListener("input", calculateAge);
document.getElementById("bMonth").addEventListener("input", calculateAge);
document.getElementById("bDay").addEventListener("input", calculateAge);
function calculateAge() {
    let y = parseInt(document.getElementById("bYear").value);
    let m = parseInt(document.getElementById("bMonth").value) -1;
    let d = parseInt(document.getElementById("bDay").value);
    if(y && m >=0 && d) {
        let birth = new Date(y,m,d);
        let ageDifMs = Date.now() - birth.getTime();
        let ageDate = new Date(ageDifMs);
        document.getElementById("age").value = Math.abs(ageDate.getUTCFullYear() - 1970);
    }
}

// Donor Type auto-fill
document.getElementById("donorType").addEventListener("input", function(){
    let val = this.value.toUpperCase();
    let extra = document.getElementById("extraBox");
    if(val === "W") this.value="WALK-IN", extra.value="";
    else if(val === "M") this.value="MBD", extra.style.display="inline";
    else if(val === "P") this.value="PATIENT DIRECTED", extra.style.display="inline";
});

// Bag Used auto-fill
document.getElementById("bagUsed").addEventListener("input", function(){
    if(this.value.toUpperCase() === "K") this.value="KARMI";
    if(this.value.toUpperCase() === "T") this.value="TERUMO";
});

// Bag Type auto-fill
document.getElementById("bagType").addEventListener("input", function(){
    let val = this.value.toUpperCase();
    if(val==="S") this.value="SINGLE";
    if(val==="D") this.value="DOUBLE";
    if(val==="T") this.value="TRIPLE";
    if(val==="Q") this.value="QUADRUPLE";
});

// Amount auto-fill
document.getElementById("amount").addEventListener("input", function(){
    let val = this.value.toUpperCase();
    if(val==="4") this.value="450mL";
    if(val==="Q") this.value="QNS";
    if(val==="U") this.value="UB";
});

// Submit donor
document.getElementById("donorForm").addEventListener("submit", function(e){
    e.preventDefault();
    saveDonor();
});

// Live Search
document.getElementById("searchDonor").addEventListener("input", function(){
    let keyword = this.value.toLowerCase();
    if(keyword==="") return renderList();
    let filtered = donors.filter(d => Object.values(d).some(v=>String(v).toLowerCase().includes(keyword)));
    renderFilteredList(filtered);
});

// Save donor logic
function saveDonor(){
    let key = document.getElementById("surname").value.trim().toUpperCase() + "|" +
              document.getElementById("fname").value.trim().toUpperCase() + "|" +
              document.getElementById("mname").value.trim().toUpperCase();
    let existing = donors.find(d => 
        (d.surname.trim().toUpperCase()+"|"+d.fname.trim().toUpperCase()+"|"+d.mname.trim().toUpperCase()) === key
    );
    let donations = parseInt(document.getElementById("numDonations").value)||1;
    let donorData = {
        date: document.getElementById("date").value,
        month: new Date(document.getElementById("date").value).toLocaleString("default",{month:"long",year:"numeric"}),
        donorType: document.getElementById("donorType").value,
        extra: document.getElementById("extraBox").value,
        surname: document.getElementById("surname").value,
        suffix: document.getElementById("suffix").value,
        fname: document.getElementById("fname").value,
        mname: document.getElementById("mname").value,
        age: document.getElementById("age").value,
        address: document.getElementById("address").value,
        city: document.getElementById("city").value,
        contact: document.getElementById("contact1").value+"-"+document.getElementById("contact2").value+"-"+document.getElementById("contact3").value,
        serial: "PRC2600-"+document.getElementById("serialNumber").value,
        bloodType: document.getElementById("bloodType").value,
        numDonations: donations,
        bagUsed: document.getElementById("bagUsed").value,
        bagType: document.getElementById("bagType").value,
        amount: document.getElementById("amount").value,
        startTime: document.getElementById("startHH").value+":"+document.getElementById("startMM").value,
        endTime: document.getElementById("endHH").value+":"+document.getElementById("endMM").value
    };
    if(existing){
        Object.assign(existing, donorData);
        existing.numDonations += 1;
    } else donors.push(donorData);
    localStorage.setItem("donors", JSON.stringify(donors));
    document.getElementById("donorForm").reset();
    document.getElementById("date").valueAsDate = new Date();
    renderList(key);
}

// Render donor list
function renderList(highlightKey=""){
    renderFilteredList(donors, highlightKey);
}

function renderFilteredList(list, highlightKey=""){
    let tbody = document.getElementById("donorTable");
    tbody.innerHTML = "";
    let grouped = {};
    list.forEach(d => { grouped[d.month]=grouped[d.month]||[]; grouped[d.month].push(d); });
    for(let m in grouped){
        tbody.innerHTML += `<tr class="month"><td colspan="16">${m}</td></tr>`;
        grouped[m].forEach(d=>{
            let bloodClass="";
            if(d.bloodType.startsWith("A")) bloodClass="bloodA";
            else if(d.bloodType.startsWith("B")&&!d.bloodType.startsWith("AB")) bloodClass="bloodB";
            else if(d.bloodType.startsWith("AB")) bloodClass="bloodAB";
            else if(d.bloodType.startsWith("O")) bloodClass="bloodO";

            let rowKey = d.surname.trim().toUpperCase()+"|"+d.fname.trim().toUpperCase()+"|"+d.mname.trim().toUpperCase();
            let highlight = (rowKey===highlightKey)?' class="highlight"':'';

            tbody.innerHTML += `<tr${highlight}>
                <td>${d.date}</td>
                <td>${d.donorType}${d.extra?" - "+d.extra:""}</td>
                <td>${d.surname}, ${d.fname} ${d.mname}</td>
                <td>${d.suffix}</td>
                <td>${d.age}</td>
                <td>${d.address}</td>
                <td>${d.city}</td>
                <td>${d.contact}</td>
                <td>${d.serial}</td>
                <td class="${bloodClass}">${d.bloodType}</td>
                <td>${d.numDonations}</td>
                <td>${d.bagUsed}</td>
                <td>${d.bagType}</td>
                <td>${d.amount}</td>
                <td>${d.startTime}</td>
                <td>${d.endTime}</td>
            </tr>`;
        });
    }
}

// Initial render
renderList();
</script>

</body>
</html>
